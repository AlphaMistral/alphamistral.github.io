<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="null">
    <meta name="keyword" content="null">
    <meta name="theme-color" content="#600090">
    <meta name="msapplication-navbutton-color" content="#600090">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#600090">
    <link rel="shortcut icon" href="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png">
    <link rel="alternate" type="application/atom+xml" title="Weymire" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        Vertical FogåŠåœ¨Fragment Shaderä¸­é‡å»ºä¸–ç•Œåæ ‡ï½œWeymire&#39;s Blog
        
    </title>

    <link rel="canonical" href="http://www.weymire.com/2016/12/04/essay2/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/blog-style.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<style>

    header.intro-header {
        background-image: url('../image/tags.jpg')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    Weymire
                </span>
                's Blog
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
					
                    
                        
							
                        <li>
                            <a href="/Portfolio/">Portfolio</a>
                        </li>
							
						
                    
                        
							
                        <li>
                            <a href="/tags/">Featured Tags</a>
                        </li>
							
						
                    
                        
                    
					
					
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="http://ol56no7p4.bkt.clouddn.com/essay2.jpg">


<style>
    
    header.intro-header {
        background-image: url('http://ol56no7p4.bkt.clouddn.com/essay2.jpg?imageView2/1/w/1400/h/400/interlace/1/q/90')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>Vertical FogåŠåœ¨Fragment Shaderä¸­é‡å»ºä¸–ç•Œåæ ‡</h1>
                    
                    <h2 class="subheading">å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•çš„åæ ‡é‡å»ºé—®é¢˜</h2>
                    
                    <span class="meta">
                         ä½œè€… Jingping Yu
                        <span>
                          æ—¥æœŸ 2016-12-04
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                        <a class="tag" href="/tags/#Unity"
                           title="Unity">Unity</a>
                        
                        <a class="tag" href="/tags/#Computer Graphics"
                           title="Computer Graphics">Computer Graphics</a>
                        
                        <a class="tag" href="/tags/#Shader"
                           title="Shader">Shader</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            Vertical FogåŠåœ¨Fragment Shaderä¸­é‡å»ºä¸–ç•Œåæ ‡
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <script src="/assets/js/DPlayer.min.js"> </script><p>æœ¬æ–‡åŒæ—¶ä¹Ÿå‘è¡¨åœ¨æˆ‘çš„<a href="https://zhuanlan.zhihu.com/p/24160707?refer=MeowShader" target="_blank" rel="external">çŸ¥ä¹ä¸“æ </a>ä¸ŠğŸ˜„.</p>
<blockquote>
<p>ä½œè€…ï¼šéŸ³é€Ÿé”®ç›˜çŒ«</p>
<p>é“¾æ¥ï¼šhttps://zhuanlan.zhihu.com/p/24160707?refer=MeowShader</p>
<p>æ¥æºï¼šçŸ¥ä¹</p>
<p>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</blockquote>
<h2>Vertical Fog (å‚ç›´é›¾) æ˜¯ä»€ä¹ˆ</h2>
<p>æƒ³å¿…å¤§å®¶éƒ½çŸ¥é“é›¾ç‰¹æ•ˆ, ä¸€èˆ¬æ¥è®², è·ç¦»æ‘„åƒæœºè¶Šè¿œçš„ç‚¹, å…¶å—åˆ°é›¾ç‰¹æ•ˆçš„å½±å“ä¼šè¶Šä¸ºä¸¥é‡. è¿™æ˜¯æœ€ä¸ºå¸¸è§çš„é›¾ç‰¹æ•ˆ.</p>
<p><img src="/image/essay2/8.jpg" alt=""></p>
<p>ä½†æ˜¯è¿˜æœ‰ä¸€ç§é›¾, åœ¨æŸä¸€ç‚¹çš„æµ“åº¦ä¸å…¶å’Œè§‚å¯Ÿç‚¹é—´çš„è·ç¦»å…³ç³»ä¼¼ä¹å¹¶ä¸å¤§, è€Œä¸å…¶<strong>ä¸–ç•Œä½ç½®åæ ‡</strong>æœ‰éå¸¸ç´§å¯†çš„è”ç³».</p>
<p><img src="/image/essay2/1.jpg" alt="">
<img src="/image/essay2/2.jpg" alt="">
<img src="/image/essay2/3.jpg" alt=""></p>
<p>æˆ‘ä¸å¤ªæ‡‚ç‰©ç†, å§‘ä¸”ç†è§£ä¸ºé›¾éœ¾å› è‡ªèº«å—åˆ°çš„é‡åŠ›è€Œäº§ç”Ÿäº†æ²‰ç§¯ä½œç”¨, ä½¿å¾—è·ç¦»åœ°é¢è¾ƒè¿‘çš„åŒºåŸŸé›¾æµ“åº¦ç‰¹åˆ«é«˜, ä½†æ˜¯ä¸€æ—¦é«˜è¿‡æŸä¸ªé˜ˆå€¼, æµ“åº¦åˆ™å¼€å§‹æ€¥å‰§ä¸‹é™.</p>
<p>ä»¥ä¸Šå±äºæˆ‘çš„ä¸æ‡‚è£…æ‡‚è¾£é¸¡è§£é‡Š. å¦‚æœæŸä½å¤§ä¾ èƒ½å¤Ÿç§‘å­¦åœ°è§£é‡Šä¸€ä¸‹, æ„Ÿæ¿€ä¸å°½.</p>
<p>ä»¥ä¸Šä¸‰å¼ ç…§ç‰‡å…¨éƒ¨æ¥è‡ªè°·æ­Œå›¾ç‰‡, æ‘„äº<em>Dubai</em>.</p>
<p>çŸ¥é“äº†Vertical Fogæ˜¯ä»€ä¹ˆä¸œè¥¿ä¹‹å, æˆ‘ä»¬å°±éœ€è¦çŸ¥é“è¿™ä¸ªç‰¹æ•ˆæœ‰ä»€ä¹ˆç”¨.</p>
<p>åœ¨å¾ˆå¤šTop-Downç±»å‹çš„æ¸¸æˆ(æ¯”å¦‚LOL, Dota, Space Marshall)ä¸­æƒ³è¦åŠ å…¥é›¾ç‰¹æ•ˆçš„è¯, ä½¿ç”¨ä¼ ç»Ÿçš„åŸºäºè·ç¦»å’Œæ·±åº¦çš„é›¾ç‰¹æ•ˆä¼šå¯¼è‡´æ•ˆæœå¤±çœŸ. è¿™æ˜¯å› ä¸ºTop-Downçš„è§†è§’æ˜¯æ¯”è¾ƒå¹¿çš„, ç®€å•ç²—æš´åœ°ç³Šä¸Šä¸€å±‚é›¾ä¼šå¯¼è‡´è®¸å¤šè·ç¦»æ‘„åƒæœºè¾ƒè¿œ, ä½†åˆå¾ˆé‡è¦çš„éƒ¨åˆ†è¢«æ¸²æŸ“ä¸ºç™½èŒ«èŒ«çš„é›¾. ä¸æ­¤ç›¸å, æˆ‘ä»¬åªå¸Œæœ›åœ¨æ”¾ç½®GameObjectçš„é‚£ä¸€å±‚äº§ç”Ÿæ¯”è¾ƒé›†ä¸­çš„é›¾, å› æ­¤å¯ä»¥è€ƒè™‘åŸºäºæ¯ä¸€ä¸ªç‚¹çš„ä¸–ç•Œåæ ‡å†³å®šå…¶é›¾çš„æµ“åº¦.</p>
<p>æœ¬æ–‡å°†è¦å®ç°åŸºäºImage Effectçš„Vertical Fogæ•ˆæœ. å½“ç„¶äº†æ€è·¯æ˜¯ç›¸é€šçš„, å¦‚æœæƒ³è¦å±€éƒ¨åœ°æ·»åŠ é›¾ç‰¹æ•ˆ, ä¹Ÿå¯ä»¥å°†ç±»ä¼¼çš„ç€è‰²å™¨ç‰¹æ•ˆåº”ç”¨äºæ¨¡å‹ä¸Š, ç„¶åæ³¨æ„è°ƒæ•´æ¨¡å‹çš„Blendä¸ZTestå°±å¥½äº†.</p>
<h2>çŒœä¸€çŒœè¿™ä¸ªç‰¹æ•ˆè¦æ€ä¹ˆå®ç°</h2>
<p>æ©, å‡è®¾æˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸çŸ¥é“, åªæœ‰ä¸€ä¸ªå¤„ç†å‰çš„å›¾å’Œå¤„ç†åçš„æ•ˆæœå›¾:</p>
<p><img src="/image/essay2/4.png" alt=""></p>
<p>åŸå›¾</p>
<p><img src="/image/essay2/5.png" alt=""></p>
<p>å¤„ç†å</p>
<p>é€šè¿‡ä¸Šé¢çš„ä¸¤å¼ å›¾, æˆ‘ä»¬èƒ½å¾—åˆ°å¦‚ä¸‹çš„ç»“è®º:</p>
<ul>
<li>1	æŸç‚¹çš„é›¾çš„æµ“åº¦, å’Œè¯¥ç‚¹çš„ä¸–ç•ŒYåæ ‡æœ‰å…³ç³».</li>
<li>2	æŸç‚¹çš„é›¾çš„æµ“åº¦, å’Œæ‘„åƒæœºçš„ä½ç½®, FOV, è§’åº¦ç­‰éƒ½æ²¡æœ‰ä»»ä½•å…³ç³».</li>
<li>3	é›¾çš„æµ“åº¦ç¬¦åˆæŸç§æ•°å­¦å…¬å¼, ä½¿å…¶æ²‰ç§¯åœ¨äº†æ¯”è¾ƒä½çš„åŒºåŸŸ.</li>
<li>4	è¿™ä¸ªç‰¹æ•ˆé€‚åˆä¿¯è§†è¢«è§‚å¯ŸåŒºåŸŸçš„æƒ…å†µ. å¦‚æœèº«åœ¨é›¾ä¸­çš„è¯, ææ€•ä»€ä¹ˆéƒ½çœ‹ä¸æ¸…æ¥š.</li>
</ul>
<p>å¾ˆæ˜æ˜¾, åªè¦èƒ½çŸ¥é“æŸä¸€ç‚¹çš„ä¸–ç•ŒYåæ ‡, é‚£ä»€ä¹ˆé—®é¢˜éƒ½è§£å†³äº†.</p>
<h2>ä¸€ä¸ªNaiveçš„æ€è·¯ (ç›´ç™½è€Œä½æ•ˆ)</h2>
<p>åœ¨ç‰‡å…ƒç€è‰²å™¨ä¸­é€†æ¨å‡ºæ¯ä¸€ä¸ªç‰‡å…ƒçš„View Spaceåæ ‡, ç„¶åä¹˜ä»¥_InverseViewçŸ©é˜µå°†ä¹‹è½¬åŒ–å›World Space.</p>
<p>é¦–å…ˆæˆ‘ä»¬å°†ç‰‡å…ƒå±å¹•åæ ‡é‡æ–°æ˜ å°„åˆ°[-1, 1]çš„åŒºé—´ä»¥å›å½’åˆ°NDC Space, éšåå°†NDC Spaceè½¬åŒ–ä¸ºView Space, å†é€šè¿‡ä»C#è„šæœ¬ä¼ å…¥çš„æ‘„åƒæœºçš„ä¸–ç•Œ-æ‘„åƒæœºå˜æ¢çŸ©é˜µçš„é€†æ±‚å‡ºå…¶ä¸–ç•Œåæ ‡.ğŸ˜</p>
<p><figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="keyword">float</span> depth = LinearEyeDepth ( SAMPLE_DEPTH_TEXTURE( _CameraDepthTexture, i.uv ) ); </div><div class="line">float2 p11_22 = float2 ( unity_CameraProjection._11, unity_CameraProjection._22 ); </div><div class="line">float3 vpos = float3( ( i.uv * <span class="number">2</span> - <span class="number">1</span>) / p11_22, <span class="number">-1</span> ) * depth; </div><div class="line">float4 wpos = mul( _InverseView, float4( vpos, <span class="number">1</span> ) ); </div><div class="line"><span class="keyword">return</span> wpos.y / <span class="number">10</span>;<span class="comment">//ä¸‹æ–‡ä¸­ä¼šè¯´åˆ°ä¸ºä»€ä¹ˆå†™å¾—è¿™ä¹ˆå¥‡æ€ª.</span></div></pre></td></tr></table></figure></p>
<p>è¿™æ®µç¨‹åºä¸­vposçš„è®¡ç®—è¿‡ç¨‹ä¸ºäº†è®©ä»£ç çœ‹èµ·æ¥ç®€å•ç‚¹è€Œåšäº†ä¸€ç‚¹å˜åŒ–, æ›´åŠ ç›´è§‚çš„æ–¹å¼æ˜¯è¿™æ ·çš„:</p>
<p><figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line">float2 ndc = i.uv * <span class="number">2</span> - <span class="number">1</span>;</div><div class="line">float3 vpos;</div><div class="line">vpos.x = ndc / p11_22.x * depth;</div><div class="line">vpos.y = ndc / p11_22.y * depth;</div><div class="line">vpos.z = -depth;</div></pre></td></tr></table></figure></p>
<p>unity_CameraProjectionä¸­å­˜å‚¨çš„æ˜¯æŠ•å½±çŸ©é˜µ. (è¿™ä¸ªæ˜¯OpenGLçš„ç‰ˆæœ¬)å…¶å½¢å¼å¦‚ä¸‹:</p>
<p><span>$$\begin{pmatrix} \frac {2n} {r - l} &amp; 0 &amp; \frac {r + l} {r - l} &amp; 0 \\
&Tab;0 &amp; \frac {2n} {t - b} &amp; \frac {t + b} {t - b} &amp; 0 \\
&Tab;0 &amp; 0 &amp; \frac {-(f + n)} {f - n} &amp; \frac {-2fn} {f - n} \\ 
&Tab;0 &amp; 0 &amp; -1 &amp; 0 \\
\end{pmatrix}$$</span><!-- Has MathJax --></p>
<p>ç‚¹å…ƒç€è‰²å™¨çš„åæ ‡å˜åŒ–å¤„ç†è¿‡ç¨‹å¦‚ä¸‹:</p>
<p><img src="/image/essay2/6.png" alt=""></p>
<p>(è¿™ä¸ªå›¾æ˜¯DirectXçš„ç‰ˆæœ¬, æ¢åˆ°OpenGLçš„è¯, å€’æ•°ç¬¬äºŒä¸ªæ¡†æ¡†ä¸­yçš„å¤„ç†åº”è¯¥å’Œxä¸€æ ·)</p>
<p>æˆ‘ä»¬ç°åœ¨ç›¸å½“äºåœ¨å€’æ•°ç¬¬äºŒä¸ªæ¡†æ¡†å†…, å”¯ä¸€ä¸åŒçš„æ˜¯æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯uvåæ ‡, èŒƒå›´æ˜¯[0, 1]è€Œå¹¶é[0, width]ä¸[0, height]. å› æ­¤ç¬¬äºŒæ®µç¨‹åºæ‰€åšçš„, å°±æ˜¯åˆ©ç”¨uvåæ ‡æ¥æ±‚å‡ºNDC Spaceåæ ‡. æ³¨æ„, åˆ°æ­¤ä¸ºæ­¢å®Œå…¨å’ŒZæ²¡æœ‰ä»»ä½•å…³ç³». æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®©xåˆ†é‡é™¤ä»¥$\frac {2n} {r - l}$, è®©yåˆ†é‡é™¤ä»¥$\frac {2n} {t - b}$å³å¯.</p>
<p>è½¬åŒ–å›NDC Spaceå, ç”±äºæˆ‘ä»¬æœ¬è´¨ä¸Šå·²ç»åšè¿‡äº†æ ‡å‡†åŒ–å’Œå‰ªè£, å› æ­¤å€’æ•°ç¬¬å››ä¸ªä¸ç¬¬äº”ä¸ªæ¡†æ¡†è·³è¿‡, æˆ‘ä»¬çš„é€†æ¨è¿‡ç¨‹è¿›å…¥åˆ°äº†è“è‰²çš„å¤§æ¡†æ¡†ä¸­. è€Œæ ¹æ®åæ ‡å˜æ¢è§„åˆ™, æˆ‘ä»¬æœ‰å¦‚ä¸‹ç­‰å¼:</p>
<p>$$
x^{'} = \frac {nP_{x}} {-P_{z}}
$$
$$
y^{'} = \frac {nP_{y}} {-P_{z}}
$$
$$
z^{'} = n
$$</p>
<p>OpenGLä¸­View Spaceçš„Zè½´æ­£æ–¹å‘èƒŒç¦»View Frustum. è€Œé€šè¿‡CameraDepthTextureæˆ‘ä»¬å¾—åˆ°çš„å€¼å‡ä¸ºæ­£, å› æ­¤éœ€è¦ç‰¹æ®Šå˜æ¢ä¸€ä¸‹.</p>
<p>OK, åˆ°æ­¤ä¸ºæ­¢æˆ‘ä»¬å·²ç»æˆåŠŸå°†Screen Spaceä¸¢åˆ°äº†View Spaceä¸­, æˆ‘ä»¬åªéœ€è¦åœ¨C#è„šæœ¬ä¸­æ’å…¥å¦‚ä¸‹ä»£ç , å°±å¯ä»¥å°†ä¸–ç•Œ-æ‘„åƒæœºå˜æ¢çŸ©é˜µçš„é€†ä¼ å…¥:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">material.SetMatrix ( &quot;_InverseView&quot;, GetComponent&lt;Camera&gt; ().cameraToWorldMatrix );</div></pre></td></tr></table></figure></p>
<p>ç„¶å, ä¹˜ä»¥è¿™ä¸ªçŸ©é˜µå³å¯:</p>
<p><figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line">float4 wpos = mul ( _InverseView, vpos );</div></pre></td></tr></table></figure></p>
<p>ç°åœ¨è¯´æ˜ä¸‹ä¸ºä»€ä¹ˆæˆ‘ä»¬æœ€åè¦æŸ¥çœ‹çš„æ˜¯<strong>wpos.y / 10</strong>. å…¶å®è¿™ä¸ª10æ˜¯æˆ‘é¡ºæ‰‹æ•²ä¸Šå»çš„ğŸ˜†, äººçœ¼å¯¹äºæš—è‰²çš„åˆ†è¾¨èƒ½åŠ›é«˜äºå¯¹æ˜äº®é¢œè‰²çš„åˆ†è¾¨èƒ½åŠ›, å› æ­¤è¿™ä¸ªè¿‡ç¨‹éå¸¸ç±»ä¼¼äºGamma Correction. ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘è¿™æ²¡æœ‰ç”¨ä¹˜æ–¹çš„å½¢å¼è¿›è¡Œæ ¡æ­£å‘¢? è¿™æ˜¯å› ä¸ºä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è®²æˆ‘ä»¬è¾“å‡ºçš„æ˜¯&quot;åæ ‡&quot;, è€Œæ¸¸æˆåœºæ™¯ä¸­çš„åæ ‡å¯èƒ½ä¼šæ¯”è¾ƒå¤§, æ¯”å¦‚å¨æˆ¿çš„æŸœå­é¡¶ç«¯å…¶yè½´åæ ‡å°±è¾¾åˆ°äº†<strong>2.5m</strong>. å› æ­¤ä¸å¦‚ç®€å•ç²—æš´åœ°é™¤ä»¥10, è¿™æ ·ä¹Ÿå¾ˆå®¹æ˜“æŸ¥çœ‹æˆ‘ä»¬æœ€åçš„ç»“æœæ˜¯å¦æ­£å¸¸ğŸ˜.</p>
<p><img src="/image/essay2/7.png" alt=""></p>
<p>å¦‚å›¾æ‰€ç¤º, è¶Šé«˜çš„åœ°æ–¹è¶Šæ˜äº®.</p>
<h2>ä½†æ˜¯, æˆ‘ä»¬ä¸å¸Œæœ›Naive</h2>
<h3>åˆ†æ</h3>
<p>ä¸ºä»€ä¹ˆä¸Šé¢ä»‹ç»çš„æ–¹æ³•ä¸å¥½? æˆ‘ä»¬éƒ½çŸ¥é“çŸ©é˜µä¹˜æ³•æ˜¯ä¸€ä¸ªé¢‡ä¸ºè€—èµ„æºçš„ä¸€ä¸ªæ“ä½œ, å“ªæ€•æ¬åˆ°GPUä¸Šä¹Ÿä¸€æ ·. è€Œä¸Šé¢çš„åšæ³•æ˜¯åœ¨ç‰‡å…ƒç€è‰²å™¨ä¸­åšåæ ‡è½¬æ¢, <strong>å±å¹•åˆ†è¾¨ç‡æ˜¯å¤šå°‘å°±åšäº†å¤šå°‘æ¬¡çŸ©é˜µä¹˜æ³•</strong> ... ğŸ˜…</p>
<h3>æ–¹æ³•</h3>
<p>ä¸çŸ¥é“è¯»è€…æ˜¯ä¸æ˜¯å’Œæˆ‘ä¸€æ ·æœ‰ä¸€ç§æ„Ÿè§‰: ä¸€ä¸ªç‰¹å®šçš„ViewPort Positionå’Œä¸€ä¸ªç‰¹å®šçš„æ·±åº¦å€¼, æ˜¯èƒ½å¤Ÿå”¯ä¸€ç¡®å®šä¸€ä¸ªä¸–ç•Œåæ ‡çš„. æˆ‘ä¸ä¼šç”»å›¾ ... è¯¸ä½è„‘è¡¥ä¸€ä¸‹å“ˆ, é€è§†æŠ•å½±çš„è¿‡ç¨‹ä¸­, å¤„åœ¨åŒä¸€æ¡ä»æ‘„åƒæœºå°„å‡ºçš„å°„çº¿ä¸Šçš„ç‚¹, æœ€ç»ˆä¼šè¢«ç»˜åˆ¶åˆ°åŒä¸€ä¸ªä½ç½®ä¸Š. (è¿™ä¹Ÿå°±æ˜¯æ·±åº¦æµ‹è¯•çš„æ„ä¹‰ä¹‹ä¸€ --- åªè®©æœ€è¿‘çš„é‚£ä¸ªç‚¹è¢«ç»˜åˆ¶å‡ºæ¥). ä½†æ˜¯å¦‚æœæˆ‘ä»¬åˆåŒæ—¶çŸ¥é“äº†å°„çº¿ä¸Šçš„æŸä¸ªç‚¹åˆ°æ‘„åƒæœºçš„è·ç¦», é‚£ä¹ˆè¿™ä¸ªç‚¹å°±æ˜¯å”¯ä¸€ç¡®å®šçš„ğŸ˜ .</p>
<p>é‚£ä¹ˆæœ€åæˆ‘ä»¬è¦å¾—åˆ°çš„ä¸–ç•Œåæ ‡å°±æ˜¯$ray * depth + _WorldSpaceCameraPos$.</p>
<p>æ©, å¦‚æœèƒ½å¿«é€Ÿå¾—åˆ°è¿™æ¡å°„çº¿å°±å¥½äº†. å…¶å®å¾—åˆ°è¿™æ¡å°„çº¿çš„æ–¹æ³•ç®€å•çš„ä»¤äººå‘æŒ‡ğŸ˜š.</p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥åœ¨C#è„šæœ¬ä¸­è®¡ç®—å‡ºæ‘„åƒæœºåˆ°å…¶View Frustumçš„è¿œå‰ªè£é¢çš„å››ä¸ªè§’çš„ä¸–ç•Œåæ ‡å°„çº¿.</li>
<li>å¯¹äºå…¨å±å¹•çš„åæœŸç‰¹æ•ˆ, å…¶å®å°±æ˜¯ä¸€ä¸ªå…¨å±å¹•çš„Quad, å››ä¸ªé¡¶ç‚¹. ä¸€ä¸ªé¡¶ç‚¹å¯¹åº”ä¸Šè¿°çš„ä¸€ä¸ªè§’.</li>
<li>ç‚¹å…ƒç€è‰²å™¨è¾“å‡ºè‡³ç‰‡å…ƒç€è‰²å™¨çš„è¿‡ç¨‹ä¸­è‡ªå¸¦æ’å€¼ ... æˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸ç”¨åš, å°±è¿™ä¹ˆåä¸½ä¸½åœ°å¾—åˆ°äº†æƒ³è¦çš„å°„çº¿.</li>
</ul>
<p>æ±‚View Frustumå››ä¸ªè§’çš„ä¸–ç•Œåæ ‡çš„C#ç¨‹åº:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Matrix4x4 frustumCorners = Matrix4x4.identity; </div><div class="line">float fovWHalf = camFov * 0.5f; </div><div class="line">Vector3 toRight = m_camTrans.right * camNear * Mathf.Tan (fovWHalf * Mathf.Deg2Rad) * camAspect; </div><div class="line">Vector3 toTop = m_camTrans.up * camNear * Mathf.Tan (fovWHalf * Mathf.Deg2Rad); </div><div class="line">Vector3 topLeft = (m_camTrans.forward * camNear - toRight + toTop); </div><div class="line">float camScale = topLeft.magnitude * camFar/camNear; </div><div class="line">topLeft.Normalize(); </div><div class="line">topLeft *= camScale; </div><div class="line">Vector3 topRight = (m_camTrans.forward * camNear + toRight + toTop); </div><div class="line">topRight.Normalize(); </div><div class="line">topRight *= camScale; Vector3 bottomRight = (m_camTrans.forward * camNear + toRight - toTop); </div><div class="line">bottomRight.Normalize(); </div><div class="line">bottomRight *= camScale; </div><div class="line">Vector3 bottomLeft = (m_camTrans.forward * camNear - toRight - toTop);</div><div class="line">bottomLeft.Normalize(); bottomLeft *= camScale; </div><div class="line">frustumCorners.SetRow (0, topLeft); </div><div class="line">frustumCorners.SetRow (1, topRight); </div><div class="line">frustumCorners.SetRow (2, bottomRight); </div><div class="line">frustumCorners.SetRow (3, bottomLeft); </div><div class="line">material.SetMatrix (&quot;_FrustumCornersWS&quot;, frustumCorners);</div></pre></td></tr></table></figure></p>
<p>ç°åœ¨æˆ‘ä»¬çš„é—®é¢˜æ˜¯å¦‚ä½•è®©è¿™ä¸ªçŸ©é˜µä»£è¡¨çš„å››ä¸ªè§’ä¸Screen Quadçš„å››ä¸ªè§’ä¸€ä¸€å¯¹åº”.</p>
<p>é€šè¿‡è§‚å¯Ÿ, æˆ‘ä»¬å¾—åˆ°äº†å¦‚ä¸‹å…³ç³»:</p>
<p>uv.x = 0, uv.y = 0 ------ index = 3;</p>
<p>uv.x = 1, uv.y = 0 ------ index = 2;</p>
<p>uv.x = 1, uv.x = 1 ------ index = 1;</p>
<p>uv.x = 0, uv.y = 1 ------ index = 0;</p>
<p>æˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªå‡½æ•°F(x, y) = index, ä½¿å…¶èƒ½ç¬¦åˆä¸Šè¿°å…³ç³». å¦åˆ™æˆ‘ä»¬åœ¨ç‚¹å…ƒç€è‰²å™¨ä¸­å°±è¦ä½¿ç”¨ifæ¥åˆ¤æ–­xä¸yçš„å…³ç³», ä»è€Œå’Œzä¸€ä¸€å¯¹åº”. æ‘†è„±äº†çŸ©é˜µä¹˜æ³•, ç„¶åå¼•å…¥äº†ä¸€å¨if ... è¿™æ³¢çœŸäº.
å®¹æ˜“æ¨çŸ¥å¦‚ä¸‹å…³ç³»: $F(x, y) = abs (3 - x - 3 * y)$.</p>
<h3>é‡è·æ–°ç”Ÿçš„ç‚¹å…ƒç€è‰²å™¨</h3>
<p><figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="function">v2f <span class="title">vert</span> <span class="params">(appdata_img v)</span> </span></div><div class="line">&#123; </div><div class="line">	v2f o; </div><div class="line">	o.vertex = mul(UNITY_MATRIX_MVP, v.vertex); </div><div class="line">	o.uv = v.texcoord.xy; </div><div class="line">	<span class="keyword">int</span> xx = (<span class="keyword">int</span>)v.vertex.x; <span class="keyword">int</span> yy = (<span class="keyword">int</span>)v.vertex.y; </div><div class="line">	<span class="keyword">int</span> z = <span class="built_in">abs</span> (<span class="number">3</span> - xx - <span class="number">3</span> * yy); </div><div class="line">	o.interpolatedRay = _FrustumCornersWS[ z ]; </div><div class="line">	o.interpolatedRay.w = ( v.vertex.z ); <span class="keyword">return</span> o; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>è®¡ç®—é›¾çš„æµ“åº¦</h2>
<p>é¦–å…ˆæˆ‘ä»¬è·å–æ¯ä¸€ä¸ªç‰‡å…ƒçš„ä¸–ç•Œåæ ‡. ç”±äºå°„çº¿å°„å‘çš„æ˜¯è¿œå‰ªè£é¢, å› æ­¤è¿™é‡Œå°†DepthBuffer Linearizeçš„æ—¶å€™ä¸è¦è½¬åŒ–æˆEyeSpace ... åº”è¯¥æ˜¯01Space.</p>
<p><figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="keyword">float</span> depth = Linear01Depth ( SAMPLE_DEPTH_TEXTURE ( _CameraDepthTexture, UnityStereoScreenSpaceUVAdjust ( i.uv, _CameraDepthTexture_ST ) ) ); </div><div class="line">float3 worldPos = ( depth * i.interpolatedRay ).xyz + _WorldSpaceCameraPos;</div></pre></td></tr></table></figure></p>
<p>ç„¶ååº”ç”¨ä¸€ä¸ªéšç€é«˜åº¦æŒ‡æ•°è¡°å‡çš„å¯†åº¦å‡½æ•°å°±å¯ä»¥äº†, åœ¨è¿™é‡Œæˆ‘éšä¾¿å†™äº†ä¸€ä¸ª, ä»…ä¾›å‚è€ƒå•¦ğŸ˜¸:</p>
<p><figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="keyword">return</span> lerp (tex2D (_MainTex, i.uv), _FogColor, saturate(<span class="built_in">exp</span>(-worldPos.y - _Start) * _Density));</div></pre></td></tr></table></figure></p>
<h3>æœ€ç»ˆæ•ˆæœ</h3>
<p><img src="/image/essay2/5.png" alt=""></p>

                <hr>
                
                <!-- å¤šè¯´ Share start -->
                <div class="ds-share"
                     style="text-align: right"
                     data-thread-key="2016/12/04/essay2/"
                     data-title="Vertical FogåŠåœ¨Fragment Shaderä¸­é‡å»ºä¸–ç•Œåæ ‡"
                     data-url="http://www.weymire.com/2016/12/04/essay2/"
                     data-images="http://www.weymire.com/2016/12/04/essay2/essay2.jpg"
                     data-content=" æœ¬æ–‡åŒæ—¶ä¹Ÿå‘è¡¨åœ¨æˆ‘çš„çŸ¥ä¹ä¸“æ ä¸ŠğŸ˜„.

ä½œè€…ï¼šéŸ³é€Ÿé”®ç›˜çŒ«
é“¾æ¥ï¼šhttps://zhuanl... | Weymire&#39;s Blog ">
                    <div class="ds-share-inline">
                        <ul class="ds-share-icons-16">
                            <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">åˆ†äº«åˆ°ï¼š</a></li>
                            <li><a class="ds-wechat flat" href="javascript:void(0);" data-service="wechat">å¾®ä¿¡</a></li>
                            <li><a class="ds-weibo flat" href="javascript:void(0);" data-service="weibo">å¾®åš</a></li>
                            <li><a class="ds-douban flat" href="javascript:void(0);" data-service="douban">è±†ç“£</a></li>
                        </ul>
                        <div class="ds-share-icons-more">
                        </div>
                    </div>
                    <hr>
                </div>
                <!-- å¤šè¯´ Share end-->
                

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/01/31/essay1/" data-toggle="tooltip" data-placement="top"
                           title="SSAOåŠå…¶ä¼˜åŒ–">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2016/11/27/essay3/" data-toggle="tooltip" data-placement="top"
                           title="ç›¸äº¤é«˜äº®(æ‰«ææ•ˆæœ)">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                
                <!-- å¤šè¯´è¯„è®ºæ¡† start -->
                <div class="comment">
                    <div class="ds-thread"
                         data-thread-key="2016/12/04/essay2/"
                         data-title="Vertical FogåŠåœ¨Fragment Shaderä¸­é‡å»ºä¸–ç•Œåæ ‡"
                         data-url="http://www.weymire.com/2016/12/04/essay2/">
                    </div>
                </div>
                <!-- å¤šè¯´è¯„è®ºæ¡† end -->
                

                

            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-text">Vertical Fog (å‚ç›´é›¾) æ˜¯ä»€ä¹ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-text">çŒœä¸€çŒœè¿™ä¸ªç‰¹æ•ˆè¦æ€ä¹ˆå®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-text">ä¸€ä¸ªNaiveçš„æ€è·¯ (ç›´ç™½è€Œä½æ•ˆ)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-text">ä½†æ˜¯, æˆ‘ä»¬ä¸å¸Œæœ›Naive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-text">åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-text">æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-text">é‡è·æ–°ç”Ÿçš„ç‚¹å…ƒç€è‰²å™¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-text">è®¡ç®—é›¾çš„æµ“åº¦</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-text">æœ€ç»ˆæ•ˆæœ</span></a></li></ol></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5 class="text-center">
                        <a href="/tags/">FEATURED TAGS</a>
                    </h5>
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Unity"
                           title="Unity">Unity</a>
                        
                        <a class="tag" href="/tags/#Computer Graphics"
                           title="Computer Graphics">Computer Graphics</a>
                        
                        <a class="tag" href="/tags/#Shader"
                           title="Shader">Shader</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>

    </div>
</article>


<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
<script type="text/javascript">
    // dynamic User by Hux
    var _user = 'yujingping';

    // duoshuo comment query.
    var duoshuoQuery = {short_name: _user};
    (function () {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->





<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/ehazon">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/yu-jing-ping-64">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">çŸ¥</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/haojen">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/AlphaMistral">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Weymire 2017
                    <br>
                    <span id="busuanzi_container_site_pv" style="font-size: 12px;">PV: <span id="busuanzi_value_site_pv"></span> Times</span>
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/blog.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://www.weymire.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-91741512-1';
    var _gaDomain = 'auto';
    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>


<!-- Baidu Tongji -->

<script>
    var _baId = 'a7bea2767d4659bf7b7a4f62100a2a13';
    // Originial
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?" + _baId;
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','null','2.0.0');
</script>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--wechat title img-->
<img class="wechat-title-img" src="image/avatar.jpg"><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>

</html>
